{% load static %}

<html>
    <link rel="stylesheet" type="text/css" href="{% static 'css/chessboard-1.0.0.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/chessle.css' %}">
    
    <head>
        <title>Chess AI: Chessle</title>
    </head>

    <body>
        
        

        <div class="container">
            
            <div class = "left-container">
                <div id = "chess-board"></div>
            </div>

            <div id = "buttons" class="buttons">
                <button onclick = "checkGuessHTML()" class="chessle-button guess"> Guess </button>
                <button onclick = "removeGuessHTML()" class="chessle-button undo"> Undo </button>
                <button onclick = "cheat()" class="chessle-button load"> Cheat </button>
                <!-- TODO <button class="chessle-button load "> Load Correct </button> TODO -->
            </div>
            
            <div class ="right-container">
                <div id = "guess-board"></div>
            </div>
        </div>

        <div class = "about"> 
            ChessAI Chessle v0.1 (not window size friendly)
        </div>
        
        
        <script src="{% static 'js/jquery-3.7.0.js' %}"></script> 
        <script src="{% static 'js/chessboard-1.0.0.js' %}"></script>
        <script src="{% static 'js/chess-0.12.0.js' %}"></script>
        <script src="{% static 'js/setupboard.js' %}"></script>
        
        <!-- ---------------------------------------------------------------------- -->
        <!-- Defines chessle logic. Submitting full guesses or removing a guess. -->
        <!-- ---------------------------------------------------------------------- -->
        <script>
            // resets the game if the guess is wrong
            function checkGuessHTML() {
                if (checkGuess() == false) {
                    //runs resetGame() with a delay to match the box coloring
                    setTimeout(()=> {
                        resetGame()
                    }, 850)
                }
            }
            // undo last move
            function removeGuessHTML() {
                
                // Prevents undoing the first two moves
                if (game.fen() === intialFen) {
                    return
                }
                removeGuess()
                game.undo()
                board.position(game.fen())
            }

            function requestOpeningHTML() {
                let input = document.getElementById("myinput")
                //print(opening_string)
                resetChessle()
                startChessle(opening_string)
                resetGame()
            }

            // Restarts the game and guesses the right answer
            function cheat() {
                
                requestOpeningHTML() //TODO works for now but doesnt make much sense
                for(let i = 0; i < 6; i++) {
                    addGuess(correctGuess[i])
                    game.move(correctGuess[i])
                    board.position(game.fen())
                    //TODO function for the above line? updateBoardState
                }
                checkGuessHTML()
            }
        </script>
        
        <!-- ---------------------------------------------------------------------- -->
        <!-- Defines standard chess logic. Adds guess to box after valid move/drop  -->
        <!-- ---------------------------------------------------------------------- -->
        <script>
            
            function onDragStart (source, piece, position, orientation) {
                // do not pick up pieces if the game is over
                if (game.game_over()) return false

                // only pick up pieces for the side to move
                if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                    (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                    return false
                }
            }
            // update the board position after the piece snap
            // for castling, en passant, pawn promotion
            function onSnapEnd () {
                board.position(game.fen())
            }

            function onDrop (source, target) {
                // see if the move is legal
                var move = game.move({
                    from: source,
                    to: target,
                    promotion: 'q' // NOTE: always promote to a queen
                })
                
                // illegal move
                if (move === null) return 'snapback'

                // Adds the last half move in the current PNG
                var pgnString = game.pgn().split(' ')
                var len = pgnString.length
                addGuess(pgnString[len-1]) //addGuess function in chessle.js
            }

            function resetGame() {
                game = new Chess()
                game.move(intialPosition[0])
                game.move(intialPosition[1])
                
                intialFen = game.fen()
                board.position(intialFen)
            }

            
        // -------------------------------------------------------------------------
        // Sets up starting game state and board
        // -------------------------------------------------------------------------
            var game = new Chess()

            var config = {
                draggable: true,
                position: 'start',
                onDrop: onDrop,
                onSnapEnd: onSnapEnd
            }
            var board = Chessboard('chess-board', config)
            
            var opening_string = "b4 e5 Bb2 Bxb4 Bxe5 Nf6 Nf3 Nc6"
            startChessle(opening_string)
            resetGame()
           
        </script>


    </body>
</html>
